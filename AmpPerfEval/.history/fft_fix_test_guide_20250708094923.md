# FFT跳零问题修复测试指南

## 修复内容总结

已实施三重防护机制解决FFT测量数值间歇性跳零问题：

### 1. 输入数据有效性检查（方案1）
**位置**：`ProcessSampleData_F32`函数开头
**功能**：
- 检查采样数据范围是否 ≥ 10mV（排除无信号情况）
- 检查数据平均值是否 ≥ 1mV（排除全零数据）
- 无效时直接返回上次有效结果，避免FFT计算

### 2. 结果有效性检查和滤波（方案2）
**位置**：`ProcessSampleData_F32`函数FFT计算后
**功能**：
- **幅度检查**：0.01V ~ 5V范围
- **频率检查**：10Hz ~ 100kHz范围  
- **变化率检查**：幅度变化不超过±50%，频率变化不超过100Hz
- **一致性检查**：数据有AC特征但FFT频率为0时判为异常

### 3. 数据采集稳定性检查（方案3）
**位置**：`Process_ADC_Data_F32`函数数据采集完成后
**功能**：
- 检查前100个ADC采样点质量
- 统计零值（≤5个）和饱和值（≤50个）
- 连续有效采样计数确保稳定性

## 测试步骤

### 第一阶段：基本功能验证
1. **编译并烧录**修复后的代码
2. **进入Basic Measurement模式**
3. **输入1kHz, 1V幅度信号**，观察：
   - FFT结果是否稳定在0.50V附近
   - 是否还会出现跳零现象
   - 频率显示是否稳定在1000Hz附近

### 第二阶段：不同幅度测试
4. **输入1kHz, 2V幅度信号**，观察：
   - FFT结果是否稳定在预期值附近
   - 跳零现象是否消失或明显减少

### 第三阶段：边界条件测试
5. **测试极小信号**：输入0.02V信号，验证是否能正确处理
6. **测试信号断开**：断开输入信号，验证是否显示合理的默认值
7. **测试频率变化**：从1kHz缓慢调到2kHz，观察过渡是否平滑

### 第四阶段：长时间稳定性测试
8. **连续观察5-10分钟**，统计：
   - 跳零次数（期望：显著减少或完全消失）
   - 测量稳定性（期望：波动 < ±5%）

## 预期效果

### 修复前现象
- FFT结果每3-5次显示会跳转到0附近
- 与输入幅度无关的随机跳零
- 用户体验差，数据不可靠

### 修复后预期
- **跳零现象基本消失**：偶尔的异常数据被过滤掉
- **显示更稳定**：数值波动明显减小
- **过渡更平滑**：信号变化时不会出现突变
- **异常情况处理**：无信号或异常情况下显示合理默认值

## 问题排查

如果问题仍然存在，按优先级检查：

### 1. 编译错误排查
- 检查是否包含了`stdbool.h`头文件
- 确认所有函数编译无误

### 2. 逻辑问题排查
- 如果完全没有显示：可能阈值设置过严，调整检查条件
- 如果还有跳零：可能需要进一步收紧检查条件

### 3. 深度调试
- 可以临时添加串口输出查看具体的过滤情况
- 统计有效/无效数据的比例

## 参数调优

如果需要微调，可以调整以下参数：

```c
// 在ProcessSampleData_F32函数中
data_range < 0.01f        // 数据范围阈值，可调整为0.005f或0.02f
amp_ratio < 0.5f          // 幅度变化阈值，可调整为0.3f或0.7f
freq_diff > 100.0f        // 频率变化阈值，可调整为50.0f或200.0f

// 在Process_ADC_Data_F32函数中  
zero_count > 5            // 零值容忍度，可调整为3或10
max_count > 50            // 饱和值容忍度，可调整为30或80
```

根据实际测试效果调整这些参数，平衡稳定性和响应速度。
