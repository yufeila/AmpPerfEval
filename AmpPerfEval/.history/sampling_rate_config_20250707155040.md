/**
 * @file sampling_rate_config.md
 * @brief STM32F407 多通道ADC采样率配置说明
 * @author 系统设计团队
 * @date 2025-01-06
 * 
 * 本文档详细解释了在STM32F407系统中使用多通道ADC扫描模式时的采样率配置逻辑。
 */

# STM32F407 多通道ADC采样率配置说明

## 1. 硬件配置概述

### ADC配置
- **ADC1**: 12位分辨率，3通道扫描模式
- **通道**: CH2(PA2), CH4(PA4), CH6(PA6) 
- **采样时间**: 15个ADC时钟周期
- **转换时间**: 12个ADC时钟周期  
- **ADC时钟**: 21MHz (系统时钟84MHz ÷ 4)
- **触发源**: TIM2_TRGO (定时器2更新事件)

### 定时器配置
- **TIM2**: 32位定时器，时钟频率84MHz
- **触发输出**: UPDATE事件触发ADC开始扫描
- **工作模式**: 每次触发启动一轮3通道扫描

## 2. 采样率计算原理

### 关键概念澄清
**重要纠正**：之前的理解有误，正确的关系是：
- **定时器触发频率** = **每个通道的采样率**
- 定时器每次触发启动一轮3通道扫描
- 每轮扫描产生3个样本（每通道1个），同时发生

### 正确的时序关系
```
定时器周期 T = 1/fs
每次触发 → ADC按序扫描CH0,CH1,CH2 → 产生3个样本
因此：每个通道的采样率 = 定时器触发频率 = fs
```

### 计算公式
```
采样率 = 定时器触发频率
ADC扫描约束：定时器触发周期 ≥ ADC完成3通道扫描的时间
```

### 硬件约束
每轮扫描最少需要的时间：
```
扫描时间 = (采样时间 + 转换时间) × 通道数 ÷ ADC时钟频率
        = (15 + 12) × 3 ÷ 21MHz
        = 81 ÷ 21MHz
        = 3.86μs
```

因此：
- **最大采样率**: 1/3.86μs ≈ 259kHz
- **每个通道都能达到259kHz采样率**

## 3. 配置函数说明

### Tim2_Config_AutoFs(float f0_hz)
- **功能**: 根据信号基波频率自动选择合适的采样率
- **约束**: 
  - Nyquist: Fs ≥ 2.5 × f0
  - 分辨率: Fs / FFT_SIZE ≤ 0.001 × f0
  - 硬件: 采样率不超过ADC扫描能力
- **返回**: 实际采样率

### Tim2_Config_Channel_Fs(float target_fs)
- **功能**: 直接设置目标采样率
- **约束**: 不超过硬件最大采样率
- **返回**: 实际采样率

## 4. 使用示例

### 扫频测量（200Hz-200kHz）
```c
// 对于200kHz信号，需要至少500kHz采样率
// 但硬件限制最大采样率约259kHz
float actual_fs = Tim2_Config_AutoFs(200000.0f);
// actual_fs ≈ 259000Hz (硬件限制)
```

### 基本测量（1kHz信号）
```c
// 对于1kHz信号，选择合适的采样率
float actual_fs = Tim2_Config_AutoFs(1000.0f);
// actual_fs ≈ 8192Hz (2的幂，满足Nyquist和分辨率要求)
```

## 5. 注意事项

1. **扫频上限**: 受ADC硬件限制，实际测量上限约为30-40kHz
2. **信号质量**: 高频时需要考虑信号衰减和噪声
3. **采样率误差**: 定时器分频器限制可能导致实际采样率略有偏差
4. **FFT分析**: 使用实际采样率进行频谱分析，避免频率偏移

## 6. 优化建议

1. **分段测量**: 对于宽频扫频，可以分段使用不同采样率
2. **插值算法**: 在分辨率不足时使用插值提高精度
3. **硬件升级**: 考虑使用更高速ADC或多ADC并行采样
4. **信号调理**: 在高频段使用适当的滤波和放大电路

## 7. 测试验证步骤

### 7.1 采样率验证
```c
// 测试不同频率下的采样率配置
float test_frequencies[] = {100.0f, 1000.0f, 10000.0f, 50000.0f, 100000.0f};
for(int i = 0; i < 5; i++) {
    float actual_fs = Tim2_Config_AutoFs(test_frequencies[i]);
    printf("Target: %.1f Hz, Actual Fs: %.1f Hz\n", test_frequencies[i], actual_fs);
}
```

### 7.2 硬件约束验证
```c
// 验证最大采样率
float max_fs = Tim2_Config_Channel_Fs(200000.0f);  // 尝试200kHz
printf("Max single channel Fs: %.1f Hz\n", max_fs);  // 应该约为86.3kHz
```

### 7.3 定时器触发频率验证
使用示波器监测TIM2_TRGO信号，验证：
- 定时器触发频率 = 单通道采样率 × 3
- ADC转换完成信号与定时器触发信号的时序关系

### 7.4 数据完整性验证
```c
// 验证DMA数据传输完整性
uint32_t start_time = HAL_GetTick();
float actual_fs = Start_ADC_DMA_TIM_System(10000.0f);
while(ADC_BufferReadyFlag != BUFFER_READY_FLAG_ALL) {
    if(HAL_GetTick() - start_time > 1000) {
        printf("DMA timeout!\n");
        break;
    }
}
// 分析采样数据质量
```

## 8. 故障排除

### 8.1 采样率不准确
- 检查定时器时钟源配置
- 验证PSC和ARR寄存器设置
- 确认ADC触发源配置

### 8.2 高频失真
- 检查ADC采样时间是否足够
- 验证信号调理电路频率响应
- 考虑降低目标频率或使用更高速ADC

### 8.3 DMA传输错误
- 检查DMA通道配置
- 验证缓冲区大小和对齐
- 确认中断优先级设置

## 9. 修改记录

- 2025-01-06: 初始版本，明确多通道采样率配置逻辑
- 修正了定时器触发频率与单通道采样率的混淆问题
- 添加了硬件约束检查和计算公式
- 增加了新的配置函数Tim2_Config_Channel_Fs()
