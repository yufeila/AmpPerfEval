# FFT跳零问题修复测试指南

## 修复内容总结

已实施轻量级防护机制解决FFT测量数值间歇性跳零问题：

### 结果有效性检查和滤波（方案2 - 放宽版）
**位置**：`ProcessSampleData_F32`函数FFT计算后
**功能**：
- **幅度检查**：0.005V ~ 5V范围（放宽下限）
- **频率检查**：1Hz ~ 200kHz范围（放宽范围）
- **变化率检查**：放宽限制以减少过度过滤
  - 幅度变化不超过±400%（从±50%放宽）
  - 频率变化不超过200Hz（从100Hz放宽）
- **渐进式过滤**：仅在明显异常时使用历史有效值

### 设计原则
- **最小干扰**：优先保证正常测量不受影响
- **异常检测**：仅过滤极端跳零情况
- **自适应**：没有历史数据时保持当前结果

## 测试步骤

### 第一阶段：基本功能验证
1. **编译并烧录**修复后的代码
2. **进入Basic Measurement模式**
3. **输入1kHz, 1V幅度信号**，观察：
   - FFT结果是否稳定在0.50V附近
   - 是否还会出现跳零现象
   - 频率显示是否稳定在1000Hz附近

### 第二阶段：不同幅度测试
4. **输入1kHz, 2V幅度信号**，观察：
   - FFT结果是否稳定在预期值附近
   - 跳零现象是否消失或明显减少

### 第三阶段：边界条件测试
5. **测试极小信号**：输入0.02V信号，验证是否能正确处理
6. **测试信号断开**：断开输入信号，验证是否显示合理的默认值
7. **测试频率变化**：从1kHz缓慢调到2kHz，观察过渡是否平滑

### 第四阶段：长时间稳定性测试
8. **连续观察5-10分钟**，统计：
   - 跳零次数（期望：显著减少或完全消失）
   - 测量稳定性（期望：波动 < ±5%）

## 预期效果

### 修复前现象
- FFT结果每3-5次显示会跳转到0附近
- 与输入幅度无关的随机跳零
- 用户体验差，数据不可靠

### 修复后预期
- **跳零现象明显减少**：极端异常数据被过滤掉
- **正常测量不受影响**：放宽的条件确保有效数据正常显示
- **过渡更平滑**：使用历史值平滑异常跳变
- **保持响应性**：最小化对正常测量的干扰

## 问题排查

如果问题仍然存在，按优先级检查：

### 1. 编译错误排查
- 检查是否包含了`stdbool.h`头文件
- 确认所有函数编译无误

### 2. 逻辑问题排查
- 如果完全没有显示：可能阈值设置过严，调整检查条件
- 如果还有跳零：可能需要进一步收紧检查条件

### 3. 深度调试
- 可以临时添加串口输出查看具体的过滤情况
- 统计有效/无效数据的比例

## 参数调优

如果需要微调，可以调整以下参数：

```c
// 在ProcessSampleData_F32函数中
data_range < 0.01f        // 数据范围阈值，可调整为0.005f或0.02f
amp_ratio < 0.5f          // 幅度变化阈值，可调整为0.3f或0.7f
freq_diff > 100.0f        // 频率变化阈值，可调整为50.0f或200.0f

// 在Process_ADC_Data_F32函数中  
zero_count > 5            // 零值容忍度，可调整为3或10
max_count > 50            // 饱和值容忍度，可调整为30或80
```

根据实际测试效果调整这些参数，平衡稳定性和响应速度。
