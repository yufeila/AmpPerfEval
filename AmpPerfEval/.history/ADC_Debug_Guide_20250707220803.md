# ADC/DMA 数据采集调试指南

## ? 目标
通过串口输出实时查看ADC原始数据，定位为什么只有DC通道有值，而AC/频率信号测量为0的问题。

## ? 已添加的调试功能

### 1. 独立测试函数
```c
void Test_ADC_Data_Collection(void);
```
- 位置：`Core/Src/adc.c`
- 功能：独立测试ADC+DMA+TIM数据采集
- 输出：通过串口显示详细的ADC原始数据和统计信息

### 2. 实时调试输出
在`Process_ADC_Data_F32()`函数中添加了实时调试输出：
- 每20次调用输出一次ADC数据统计
- 减少串口负载，避免影响系统性能
- 显示3个通道的平均值和动态范围

## ? 使用方法

### 步骤1：编译和烧录
1. 编译项目（确保串口相关代码已正确配置）
2. 烧录到STM32F407开发板
3. 连接串口到PC（通常是UART1）

### 步骤2：串口设置
- 波特率：115200（根据你的UART配置）
- 数据位：8
- 停止位：1
- 奇偶校验：无
- 流控：无

### 步骤3A：使用独立测试函数
在`main.c`中临时添加测试调用：
```c
int main(void)
{
  // ...现有初始化代码...
  
  // 临时添加：独立ADC测试
  HAL_Delay(2000);  // 等待系统稳定
  Test_ADC_Data_Collection();  // 调用测试函数
  
  // ...现有主循环...
}
```

### 步骤3B：使用实时调试输出
正常运行程序，进入Basic Measurement模式，串口会自动输出ADC数据统计。

## ? 预期输出格式

### 独立测试函数输出
```
=== ADC Data Collection Test Start ===
Buffer cleared. BUF_SIZE = 6144
ADC+DMA started successfully
ADC collection completed in 45 ms
First 10 raw ADC values:
[0] CH2=2048, CH4=2048, CH6=2620
[1] CH2=2100, CH4=2100, CH6=2620
[2] CH2=1996, CH4=1996, CH6=2620
...
[9] CH2=2048, CH4=2048, CH6=2620

=== ADC Statistics (100 samples) ===
CH2 (Input):  Min=1950, Max=2150, Avg=2048, Range=200
CH4 (AC Out): Min=1950, Max=2150, Avg=2048, Range=200
CH6 (DC Out): Min=2618, Max=2622, Avg=2620, Range=4

=== Voltage Conversion ===
CH2 (Input):  1.650V
CH4 (AC Out): 1.650V
CH6 (DC Out): 2.111V
=== Test Completed ===
```

### 实时调试输出
```
[ADC] CH2: 2048(200) CH4: 2048(200) CH6: 2620(4)
[ADC] CH2: 2050(180) CH4: 2050(180) CH6: 2621(3)
[ADC] CH2: 2045(220) CH4: 2045(220) CH6: 2619(5)
```

## ? 结果分析

### 正常情况（有1kHz, 2V AC信号）
- **CH2/CH4 Range > 100**：表明有明显的AC信号变化
- **CH2/CH4 平均值 ≈ 2048**：表明信号以中点为中心
- **CH6 Range < 10**：DC信号应该相对稳定

### 异常情况分析

#### 情况1：所有通道都为0
```
[ADC] CH2: 0(0) CH4: 0(0) CH6: 0(0)
```
**原因**：DMA未工作或adc_buffer未更新
**解决**：检查DMA配置、TIM触发、ADC初始化

#### 情况2：所有通道都是相同值
```
[ADC] CH2: 2048(0) CH4: 2048(0) CH6: 2048(0)
```
**原因**：所有通道短路或配置错误
**解决**：检查硬件连接、ADC通道配置

#### 情况3：只有CH6有合理值
```
[ADC] CH2: 2048(0) CH4: 2048(0) CH6: 2620(4)
```
**原因**：PA2、PA4引脚无AC信号输入
**解决**：检查信号源、硬件连接、信号幅度

#### 情况4：Range都为0
```
[ADC] CH2: 2048(0) CH4: 2048(0) CH6: 2620(0)
```
**原因**：采样速度过快或信号频率过低
**解决**：调整采样率、检查信号频率

## ? 常见问题

### 1. 串口无输出
- 检查UART初始化是否正确
- 确认串口线连接正确
- 验证波特率设置

### 2. 数据异常
- 确认输入信号在0-3.3V范围内
- 检查信号源是否正常工作
- 验证ADC参考电压

### 3. 系统卡死
- 可能是串口传输超时
- 减少调试输出频率
- 检查中断优先级设置

## ? 调试步骤总结

1. **先用独立测试**：确认ADC+DMA基本工作正常
2. **分析原始数据**：判断问题在数据采集还是处理环节
3. **检查信号源**：用示波器验证PA2、PA4引脚的信号
4. **对比预期值**：根据输入信号计算预期的ADC值
5. **逐步排除**：从硬件到软件逐步排查问题

通过这些调试信息，我们能够快速定位问题是在ADC数据采集环节，还是在后续的FFT处理和显示环节。
