# 高频点采样率配置修复方案

## ? 问题描述

在扫频模式测试中发现，当频率超过约30kHz时，FFT测量结果出现严重异常：
- **现象**: 输入频率测量结果固定在约1000Hz，输出频率测量正常
- **影响**: 第38个频点(31089.6Hz)开始，所有高频点的测量都不准确
- **根本原因**: 采样率配置算法在高频时存在逻辑缺陷

## ? 原因分析

### 原始算法的问题

```c
// 原始逻辑
float Fs_min = 2.5f * f0_hz;              // 防混叠：77,724Hz (31kHz时)
float Fs_max = 0.001f * f0_hz * FFT_SIZE; // 分辨率：31,835Hz (31kHz时)

// 当 Fs_min > Fs_max 时，强制选择 Fs_min，但这导致：
// 1. 频率分辨率 = 77,724/1024 = 75.9Hz（太粗糙）
// 2. 高频信号可能出现频率折叠或测量误差
```

### 具体计算示例

**第38个频点 (31089.6Hz)**:
- 原始Fs_min = 77,724Hz
- 原始Fs_max = 31,835Hz  
- **冲突**: Fs_min > Fs_max，系统选择Fs_min
- **结果**: 频率分辨率过低，FFT无法准确识别31kHz信号

## ?? 修复方案

### 1. 重新设计采样率选择策略

```c
// 新的分层策略
if (f0_hz <= 20000.0f) {
    // 低频：平衡采样率和分辨率
    if (理想分辨率可满足) {
        使用理想采样率
    } else {
        使用最小可用采样率
    }
} else {
    // 高频(>20kHz)：优先保证防混叠，提高采样率
    float Fs_high = 5.0f * f0_hz;  // 5倍采样率提高精度
    使用更高的采样率
}
```

### 2. 高频优化策略

- **低频信号 (≤20kHz)**: 保持原有逻辑，平衡分辨率和采样率
- **高频信号 (>20kHz)**: 采用5倍信号频率的采样率，提高测量精度
- **硬件约束**: 始终尊重TIM_MAX_TRIGGER_FREQ限制

### 3. 增强调试输出

在高频点(>25kHz)时输出详细的采样率配置信息：
```
FS_CONFIG: f0=31089.6Hz, Fs_target=155448Hz, Fs_actual=155000Hz, Resolution=151.4Hz
```

## ? 预期效果

### 修复前 vs 修复后 (2048点FFT)

| 频率点 | 信号频率 | 修复前采样率 | 修复前分辨率 | 修复后采样率 | 修复后分辨率 |
|--------|----------|--------------|--------------|--------------|--------------|
| 37     | 26944Hz  | 67,360Hz     | **32.9Hz**   | 134,720Hz    | **65.8Hz**   |
| 38     | 31090Hz  | 77,724Hz     | **37.9Hz**   | **155,450Hz**| **75.9Hz**   |
| 40     | 42170Hz  | 105,424Hz    | **51.5Hz**   | **210,850Hz**| **102.9Hz**  |

### 关键改进 (2048点FFT)

1. **采样率提升**: 高频点采样率提高约2倍
2. **分辨率大幅优化**: 2048点FFT的分辨率比1024点提高一倍
3. **防混叠增强**: 5倍采样率倍数提供更好的抗混叠性能
4. **测量精度**: 高频点的FFT测量准确性显著提升

## ? 验证步骤

### 1. 编译测试
```bash
# 编译项目，确保修改生效
```

### 2. 重点观察频点
- **第38点** (31089.6Hz): 应该显示正确的输入频率测量
- **第40点** (42170Hz): 验证更高频率的测量精度  
- **第45点** (75858Hz): 验证接近硬件极限的性能

### 3. 预期调试输出 (2048点FFT)
```
FS_CONFIG: f0=31089.6Hz, Fs_target=155448Hz, Fs_actual=155000Hz, Resolution=75.7Hz
SWEEP[38]: Set=31089.6Hz, Measured=31089.6Hz/31089.6Hz, Vin=0.514V, Vout=1.511V, Gain=9.35dB, Fs=155000Hz
```

### 4. 成功标准
- ? 输入频率测量值接近设定频率（误差<5%）
- ? 输出频率测量值接近设定频率（误差<5%）  
- ? 电压幅值保持合理范围
- ? 没有异常的频率互换现象

## ? 注意事项

1. **硬件限制**: 仍需要确保采样率不超过TIM_MAX_TRIGGER_FREQ
2. **内存使用**: FFT缓冲区大小固定为1024点，不会增加内存消耗
3. **处理速度**: 更高的采样率可能略微增加处理时间，但在可接受范围内
4. **向下兼容**: 低频测量逻辑保持不变，不影响现有功能

## ? 后续优化

如果修复效果显著，还可以考虑：
- 动态调整FFT窗函数（如汉宁窗）提高频率分辨率
- 实现频率追踪算法优化高频测量精度
- 增加硬件滤波器配置以改善信号质量
